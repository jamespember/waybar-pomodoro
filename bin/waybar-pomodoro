#!/usr/bin/env python3
# Pomodoro timer for Waybar
import json
import time
import os 

state_file = os.path.expanduser("~/.cache/pomodoro-state.txt")

def format_time(seconds):
    minutes = seconds // 60
    seconds = seconds % 60
    return f"{minutes:02d}:{seconds:02d}"

def calc_time_remaining(start_time_from_state_file):
    session_time = 1500 # 25 mins 
    elapsed_time = time.time() - start_time_from_state_file
    remaining = session_time - elapsed_time

    if remaining <= 0:
        # Timer expired
        output = {
            "text": "00:00",
            "class": "expired",
            "tooltip": "Timer finished!"
        }
    else:
        output = {
            "text": f"Remaining: {format_time(int(remaining))}",
            "class": "active",
            "tooltip": f"Remaining: {format_time(int(remaining))}"
        }
    return json.dumps(output) 

def start_timer():
    # Write current timestamp to a state file
    start_time = time.time()
    with open (state_file, "w") as file:
        file.write(str(start_time))

def get_timer_state():
    with open(state_file, "r") as file:
        start_time_from_state_file = float(file.read())
    return calc_time_remaining(start_time_from_state_file)

def stop():
    if os.path.exists(state_file):
        os.remove(state_file)


if os.path.exists(state_file): # Timer is runnning 
    print(get_timer_state())
else:
    # Time is idle
    idle_output = {
        "text": "Idle",
        "class": "idle",
        "tooltip": "No timer running"
    }
    print(json.dumps(idle_output))


